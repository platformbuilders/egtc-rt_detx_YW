########################################################################################
#                                                                                      #
#                                                                                      #
#    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó                      #
#    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë                     #
#    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë                     #
#    ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó                      #
#    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ï¶‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù                      #
#    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë                      #
#                                                                                      #
#     https://paltformbuilders.io  |  contato@platformbuilders.io                      #
#                                                                                      #
########################################################################################

##Sistema de Detec√ß√£o de EPI (Equipamentos de Prote√ß√£o Individual)

Sistema de detec√ß√£o e monitoramento de EPIs em tempo real utilizando RT-DETR-X para detec√ß√£o de pessoas e YOLO-World/OWL-V2 para detec√ß√£o de equipamentos de prote√ß√£o individual.

## üìã Caracter√≠sticas

- **Detec√ß√£o de Pessoas**: Utiliza RT-DETR-X (Ultralytics) para detec√ß√£o precisa de pessoas
- **Detec√ß√£o de EPIs**: Suporta YOLO-World e OWL-V2 para detec√ß√£o de equipamentos de prote√ß√£o
- **Rastreamento**: Sistema de rastreamento de pessoas com ByteTrack
- **ROI (Regi√£o de Interesse)**: Suporte a pol√≠gonos de ROI para √°reas espec√≠ficas
- **Sistema de Alertas**: 
  - Alertas configur√°veis com debounce e confirma√ß√£o
  - Integra√ß√£o com Telegram
  - Persist√™ncia em banco de dados (MySQL, PostgreSQL, Oracle)
  - Grid visual de alertas
  - Salvamento autom√°tico de imagens (crops ou frames completos)
- **M√©tricas**: Coleta de m√©tricas de performance e detec√ß√£o
- **Interface Visual**: Bounding boxes coloridos, pain√©is informativos e grid de alertas

## üîß Requisitos

### Hardware
- GPU NVIDIA com suporte CUDA - Recomendamos modelos T4, T40, L40 ou similares. RTX 30XX e 40XX tamb√©m s√£o suportadas.
- M√≠nimo 16GB RAM
- Espa√ßo em disco para v√≠deos e imagens de alertas - recomendamos uma parti√ß√£o /data separada)

### Software
- Ubuntu Server Minimal vers√£o 22.04
- driver nVidia vers√£o 535 (obrigat√≥rio manter esta vers√£o)
- CUDA 12.x (drivers ser√£o instalados automaticamente)
- Python 3.10 ou superior
- **Redis** (obrigat√≥rio para sistema de alertas - veja se√ß√£o dedicada abaixo)
- MySQL/PostgreSQL/Oracle (opcional, para persist√™ncia de alertas)


## üì¶ Instala√ß√£o

## 0. Instala√ß√£o de pr√©-requisitos de infraestrutura

### 0.1 - Driver nVidia

```bash
sudo apt update
sudo apt install ubuntu-drivers-common
sudo apt install nvidia-driver-535
```

Ap√≥s a instala√ß√£o ser conclu√≠da, reinicie o sistema

```bash
sudo reboot
```

Teste a instala√ß√£o do driver com:

```bash
nvidia-smi
```

Voc√™ dever√° receber uma tela com a vers√£o do driver, o modelo da placa e outras informa√ß√µes

```bash
+---------------------------------------------------------------------------------------+
| NVIDIA-SMI 535.274.02             Driver Version: 535.274.02   CUDA Version: 12.2     |
|-----------------------------------------+----------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |         Memory-Usage | GPU-Util  Compute M. |
|                                         |                      |               MIG M. |
|=========================================+======================+======================|
|   0  Tesla T4                       Off | 00000000:00:04.0 Off |                    0 |
| N/A   68C    P0              31W /  70W |    262MiB / 15360MiB |      1%      Default |
|                                         |                      |                  N/A |
+-----------------------------------------+----------------------+----------------------+
                                                                                         
+---------------------------------------------------------------------------------------+
| Processes:                                                                            |
|  GPU   GI   CI        PID   Type   Process name                            GPU Memory |
|        ID   ID                                                             Usage      |
|=======================================================================================|
|                                                                                       |
|                                                                                       |
+---------------------------------------------------------------------------------------+
```

### 1. Clone o reposit√≥rio

```bash
git clone <url-do-repositorio>
cd egtc_detr
```

### 2. Crie um ambiente virtual

```bash
python3 -m venv egtc_detr_venv
source egtc_detr_venv/bin/activate  # Linux/Mac
# ou
egtc_detr_venv\Scripts\activate  # Windows
```

### 3. Instale as depend√™ncias do sistema (apt-get)

**Op√ß√£o 1: Usando o script automatizado**
```bash
sudo ./install_system_deps.sh
```

**Op√ß√£o 2: Instala√ß√£o manual**
```bash
sudo apt update
sudo apt install -y $(grep -v '^#' apt_requirements.txt | tr '\n' ' ')
```

**Op√ß√£o 3: Instala√ß√£o seletiva**
Consulte o arquivo `apt_requirements.txt` e instale apenas os pacotes necess√°rios.

**üí° Nota sobre pacotes opcionais:**

O arquivo `apt_requirements.txt` cont√©m dois tipos de pacotes:
- **Essenciais**: Necess√°rios para o funcionamento b√°sico (Python, Redis, etc.)
- **Opcionais**: Necess√°rios apenas se voc√™ precisar compilar bibliotecas Python do c√≥digo-fonte

Se voc√™ instala depend√™ncias Python via `pip install -r requirements.txt`, a maioria j√° vem pr√©-compilada (wheels) e voc√™ **N√ÉO precisa** dos pacotes opcionais marcados com `#OPCIONAL`.

Os pacotes opcionais s√£o necess√°rios apenas se:
- Voc√™ precisar compilar bibliotecas do c√≥digo-fonte
- Voc√™ usar vers√µes espec√≠ficas n√£o dispon√≠veis como wheels
- Voc√™ estiver em uma arquitetura incomum (ARM, etc.)

Para instalar apenas os essenciais:
```bash
sudo apt install -y $(grep -v '^#' apt_requirements.txt | grep -v '^#OPCIONAL' | tr '\n' ' ')
```

Para instalar tamb√©m os opcionais (se necess√°rio):
```bash
sudo apt install -y $(grep -v '^#' apt_requirements_optional.txt | tr '\n' ' ')
```

**Verificar depend√™ncias instaladas:**
```bash
./check_system_deps.sh
```

Este script verifica quais pacotes do `apt_requirements.txt` est√£o:
- ‚úÖ Instalados e atualizados
- ‚ö†Ô∏è Instalados mas desatualizados
- ‚ùå N√£o instalados
- ‚ö†Ô∏è N√£o encontrados nos reposit√≥rios

E fornece comandos sugeridos para instalar/atualizar o que falta.

### 4. Instale as depend√™ncias Python

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

**üí° Atualizando requirements.txt:**

Se voc√™ instalou novos pacotes no ambiente virtual e quer atualizar o `requirements.txt`:

```bash
./update_requirements.sh
```

Este script:
- Faz backup do `requirements.txt` atual
- Gera um novo `requirements.txt` com todas as depend√™ncias instaladas
- Mostra estat√≠sticas e diferen√ßas (opcional)

### 4. Instale e configure o Redis

O Redis √© **obrigat√≥rio** para o funcionamento do sistema de alertas. Ele √© usado para:
- Supress√£o espacial de alertas (evitar alertas duplicados na mesma regi√£o)
- Rastreamento de viola√ß√µes j√° alertadas (hash de viola√ß√µes)
- Gerenciamento de estado tempor√°rio

**Instala√ß√£o do Redis:**

**Linux (Ubuntu/Debian):**
```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis-server
sudo systemctl enable redis-server
```

**Linux (CentOS/RHEL):**
```bash
sudo yum install redis
sudo systemctl start redis
sudo systemctl enable redis
```

**macOS:**
```bash
brew install redis
brew services start redis
```

**Windows:**
Baixe e instale do site oficial: https://redis.io/download

**Verificar se o Redis est√° rodando:**
```bash
redis-cli ping
# Deve retornar: PONG
```

**Configura√ß√£o do Redis no projeto:**

O Redis √© configurado automaticamente atrav√©s do arquivo `db_config.env`:

```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
```

### 5. Instale depend√™ncias opcionais

**Para PostgreSQL:**
```bash
pip install psycopg2-binary
```

**Para Oracle:**
```bash
pip install cx_Oracle
```

**Para OpenAI CLIP (necess√°rio para YOLO-World):**
```bash
pip install openai-clip
```

**Para OWL-V2 (opcional):**
```bash
pip install transformers torch pillow
```

### 6. Baixe os modelos

Os modelos ser√£o baixados automaticamente na primeira execu√ß√£o, ou voc√™ pode baix√°-los manualmente:

- RT-DETR-X: `rtdetr-x.pt` ou `rtdetr-l.pt`
- YOLO-World: `yolov8m-world.pt` ou `yolov8s-world.pt`

## ‚öôÔ∏è Configura√ß√£o

### 1. Configura√ß√£o da C√¢mera

Edite o arquivo de configura√ß√£o YAML (ex: `config/stream_rtdetr_cam63.yaml`):

```yaml
cameras:
  - id: CAM063
    uri: "rtsp://usuario:senha@ip:porta/caminho"

out_dir: "./out"
save_video: true
video_fps: 1
```

### 2. Documenta√ß√£o Completa dos Par√¢metros YAML

Veja a se√ß√£o [**üìã Refer√™ncia Completa de Par√¢metros YAML**](#-refer√™ncia-completa-de-par√¢metros-yaml) abaixo para documenta√ß√£o detalhada de todos os par√¢metros.

### 3. Configura√ß√£o de ROI

Crie arquivos JSON com os pol√≠gonos de ROI em `rois/`:

```json
{
  "roi_epi_on": {
    "resolution": [1920, 1080],
    "polygons": [
      [[x1, y1], [x2, y2], [x3, y3], [x4, y4]]
    ]
  }
}
```

### 4. Configura√ß√£o de EPIs por ROI

No arquivo YAML da c√¢mera, configure os EPIs necess√°rios por ROI:

```yaml
roi_ppe_config:
  roi_epi_on:
    required_ppe:
      - helmet_white
      - vest
```

### 5. Configura√ß√£o de Alertas

Crie o arquivo `db_config.env`:

```env
# Banco de Dados
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_USER=seu_usuario
DB_PASSWORD=sua_senha
DB_NAME=egtc_alerts

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# Telegram (opcional)
TELEGRAM_TOKEN=seu_token
TELEGRAM_CHAT_ID=seu_chat_id

# Timezone
TIMEZONE_OFFSET_HOURS=-3.0

# Salvamento de Imagens
SAVE_ALERT_IMAGES=true
SAVE_CROP_ONLY=true
CROPS_DIR=crops
```

### 6. Configura√ß√£o de Alertas no YAML

No arquivo YAML da c√¢mera:

```yaml
# Sistema de Alertas
enable_alerts: true
show_alert_grid: true
alert_debounce_seconds: 15.0
alert_min_consecutive_frames: 20
alert_suppression_reset_seconds: 20.0
alert_hash_ttl_seconds: 60.0
alert_grid_size: 8
timezone_offset_hours: -3.0
save_alert_images: true
save_crop_only: true
crops_dir: crops
```

## üöÄ Uso

### Execu√ß√£o B√°sica

```bash
python3 pipeline_RETDETRX_YW.py \
  --config config/stream_rtdetr_cam63.yaml \
  --prompts config/ppe_prompts_rtdetr.yaml \
  --show-video
```

### Execu√ß√£o Completa com ROI e Alertas

```bash
python3 pipeline_RETDETRX_YW.py \
  --config config/stream_rtdetr_cam63.yaml \
  --prompts config/ppe_prompts_rtdetr.yaml \
  --roi rois/roi_cam63.json \
  --roi-polys roi_epi_on \
  --draw-roi \
  --show-video \
  --enable-alerts \
  --show-alert-grid \
  --alert-config db_config.env
```

### Par√¢metros Principais

| Par√¢metro | Descri√ß√£o |
|-----------|-----------|
| `--config` | Arquivo YAML de configura√ß√£o da c√¢mera |
| `--prompts` | Arquivo YAML com prompts de EPIs |
| `--roi` | Arquivo JSON com defini√ß√£o de ROI |
| `--roi-polys` | Nome do pol√≠gono de ROI a usar |
| `--draw-roi` | Desenha ROI no v√≠deo |
| `--show-video` | Exibe v√≠deo em tempo real |
| `--no-save-video` | N√£o salva v√≠deo (apenas exibe) |
| `--enable-alerts` | Habilita envio de alertas (banco/Telegram) |
| `--show-alert-grid` | Exibe grid de alertas no v√≠deo |
| `--alert-config` | Caminho do arquivo de configura√ß√£o de alertas |
| `--debug` | Modo debug com logs detalhados |
| `--show-rtdetr-boxes` | Mostra bounding boxes brutos do RT-DETR-X |

## üìÅ Estrutura de Arquivos

```
egtc_detr/
‚îú‚îÄ‚îÄ pipeline_RETDETRX_YW.py    # Script principal
‚îú‚îÄ‚îÄ rtdetr_detector.py          # Detector de pessoas (RT-DETR-X)
‚îú‚îÄ‚îÄ ppe_detector.py             # Detector unificado de EPIs
‚îú‚îÄ‚îÄ yolo_world_ppe.py           # Implementa√ß√£o YOLO-World
‚îú‚îÄ‚îÄ tracker.py                  # Sistema de rastreamento
‚îú‚îÄ‚îÄ alerts.py                   # Sistema de alertas
‚îú‚îÄ‚îÄ utils.py                    # Fun√ß√µes utilit√°rias
‚îú‚îÄ‚îÄ ovd.py                      # Implementa√ß√£o OWL-V2 (opcional)
‚îú‚îÄ‚îÄ config/                     # Arquivos de configura√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ stream_rtdetr_cam63.yaml
‚îÇ   ‚îî‚îÄ‚îÄ ppe_prompts_rtdetr.yaml
‚îú‚îÄ‚îÄ rois/                       # Defini√ß√µes de ROI
‚îÇ   ‚îî‚îÄ‚îÄ roi_cam63.json
‚îú‚îÄ‚îÄ crops/                      # Imagens de alertas salvos
‚îú‚îÄ‚îÄ out/                        # V√≠deos e m√©tricas de sa√≠da
‚îú‚îÄ‚îÄ db_config.env               # Configura√ß√£o de banco/Redis
‚îî‚îÄ‚îÄ requirements.txt            # Depend√™ncias Python
```

## üéØ Funcionalidades Detalhadas

### Detec√ß√£o de EPIs

O sistema detecta os seguintes EPIs (com base no prompt especificado com --prompts):
- Capacete (com detec√ß√£o de cor: branco, vermelho, azul, amarelo, marrom, cinza)
- Colete refletivo
- Avental
- Luvas
- Protetor auricular

### Sistema de Alertas

1. **Confirma√ß√£o de Viola√ß√£o**: 
   - Requer 20 frames consecutivos da mesma pessoa sem EPI
   - E pelo menos 15 segundos de viola√ß√£o
   - Ambos os crit√©rios devem ser satisfeitos

2. **Supress√£o Espacial**: 
   - Evita alertas duplicados na mesma regi√£o (grid 8x8)
   - Reset autom√°tico ap√≥s 20 segundos sem viola√ß√£o

3. **Integra√ß√£o Telegram**: 
   - Envia crop da pessoa sem EPI
   - Mensagem formatada com detalhes do evento
   - Timestamp no timezone local configurado

4. **Persist√™ncia**: 
   - Salva alertas no banco de dados
   - Armazena caminho da imagem salva
   - Suporta MySQL, PostgreSQL e Oracle

### Visualiza√ß√£o

- **Bounding Boxes**:
  - Verde: Pessoa em conformidade
  - Amarelo: Viola√ß√£o detectada (aguardando confirma√ß√£o) - "AVALIANDO"
  - Vermelho: Alerta enviado - "ALERTA"

- **Grid de Alertas**: 
  - C√©lulas vermelhas: Alertas enviados (suprimidas)
  - C√©lulas laranja: Viola√ß√µes ativas (aguardando confirma√ß√£o)

- **Painel de EPIs**: 
  - Mostra status de cada EPI monitorado
  - Indica status do alerta (gerado, aguardando, etc.)

## üîç Troubleshooting

### Problema: Modelo n√£o carrega

**Solu√ß√£o**: Verifique se o modelo est√° no diret√≥rio correto e se h√° espa√ßo em disco suficiente. Os modelos ser√£o baixados automaticamente na primeira execu√ß√£o.

### Problema: CUDA out of memory

**Solu√ß√£o**: Reduza o `imgsz` no arquivo YAML ou use um modelo menor (ex: `rtdetr-x.pt` ao inv√©s de `rtdetr-l.pt`).

### Problema: Redis n√£o conecta

**Solu√ß√£o**: 
1. Verifique se o Redis est√° rodando:
```bash
redis-cli ping
# Deve retornar: PONG
```

2. Verifique as configura√ß√µes em `db_config.env`:
```env
REDIS_HOST=localhost
REDIS_PORT=6379
```

3. Se usar Redis remoto, verifique firewall e conectividade:
```bash
telnet <redis_host> 6379
```

4. Verifique logs do Redis:
```bash
sudo journalctl -u redis -f
```

### Problema: Banco de dados n√£o conecta

**Solu√ß√£o**: 
1. Verifique as credenciais em `db_config.env`
2. Certifique-se de que o banco existe
3. A tabela ser√° criada automaticamente na primeira execu√ß√£o

### Problema: Telegram n√£o envia alertas

**Solu√ß√£o**:
1. Verifique se `TELEGRAM_TOKEN` e `TELEGRAM_CHAT_ID` est√£o corretos
2. Certifique-se de que `enable_alerts=true` no YAML ou use `--enable-alerts`
3. Verifique se o bot foi iniciado no Telegram

### Problema: Falsos positivos

**Solu√ß√£o**: Ajuste os par√¢metros no YAML:
- Aumente `alert_min_consecutive_frames` (padr√£o: 20)
- Aumente `alert_debounce_seconds` (padr√£o: 15.0)
- Ajuste `rtdetr_conf` para filtrar detec√ß√µes menos confi√°veis

## üìä M√©tricas

O sistema gera arquivos CSV com m√©tricas em `out/metrics_CAM*.csv`:
- FPS de processamento
- Tempo de detec√ß√£o (RT-DETR, PPE, tracking)
- N√∫mero de pessoas detectadas
- N√∫mero de viola√ß√µes

## üìã Refer√™ncia Completa de Par√¢metros YAML

Esta se√ß√£o documenta todos os par√¢metros dispon√≠veis no arquivo de configura√ß√£o YAML (`config/stream_rtdetr_cam63.yaml`).

### Estrutura B√°sica

```yaml
cameras:
  - id: CAM063
    uri: "rtsp://usuario:senha@ip:porta/caminho"
```

### Par√¢metros de C√¢mera

| Par√¢metro | Tipo | Descri√ß√£o | Valores Recomendados |
|-----------|------|-----------|---------------------|
| `cameras[].id` | string | Identificador √∫nico da c√¢mera | Ex: `CAM063`, `CAM001` |
| `cameras[].uri` | string | URI da c√¢mera (RTSP ou arquivo) | `rtsp://...` ou `/caminho/video.mp4` |

### Par√¢metros de Sa√≠da

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `out_dir` | string | Diret√≥rio para salvar v√≠deos e m√©tricas | `"./out"` | `"./out"` |
| `save_video` | boolean | Salvar v√≠deo processado | `false` (mais r√°pido) | `true` (grava√ß√£o) |
| `video_fps` | float | FPS de grava√ß√£o do v√≠deo | `0.5` (menos espa√ßo) | `1.0` (padr√£o) |

**Recomenda√ß√µes:**
- **Performance**: `save_video: false` se n√£o precisar gravar
- **Qualidade**: `video_fps: 1.0` para capturar eventos importantes

### Par√¢metros de Amostragem

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `target_fps` | float | FPS alvo de processamento | `0.5` (menos carga) | `1.0` (padr√£o) |

**Recomenda√ß√µes:**
- **Performance**: `0.5` para reduzir carga (1 frame a cada 2 segundos)
- **Qualidade**: `1.0` para detec√ß√£o mais responsiva

### Par√¢metros RT-DETR-X (Detec√ß√£o de Pessoas)

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `rtdetr_weights` | string | Modelo RT-DETR-X | `rtdetr-m.pt` (r√°pido) | `rtdetr-l.pt` (preciso) |
| `rtdetr_imgsz` | int | Tamanho de processamento | `640` (r√°pido) | `1280` (preciso) |
| `rtdetr_conf` | float | Threshold de confian√ßa | `0.4` (mais detec√ß√µes) | `0.5` (menos falsos) |
| `rtdetr_iou` | float | Threshold IoU para NMS | `0.45` (padr√£o) | `0.45` (padr√£o) |

**Modelos dispon√≠veis:**
- `rtdetr-x.pt`: Extra Large (mais preciso, mais lento)
- `rtdetr-l.pt`: Large (balanceado) ‚≠ê **Recomendado**
- `rtdetr-m.pt`: Medium (mais r√°pido, menos preciso)

**Recomenda√ß√µes:**
- **Performance**: `rtdetr-m.pt` + `imgsz: 640` + `conf: 0.4`
- **Qualidade**: `rtdetr-l.pt` + `imgsz: 1280` + `conf: 0.5`

### Filtros RT-DETR-X (Valida√ß√£o de Detec√ß√µes)

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `rtdetr_min_area` | float | √Årea m√≠nima relativa (0-1) | `0.0001` (mais detec√ß√µes) | `0.0005` (filtra pequenos) |
| `rtdetr_max_area` | float | √Årea m√°xima relativa (0-1) | `0.8` (padr√£o) | `0.8` (padr√£o) |
| `rtdetr_min_aspect_ratio` | float | Aspect ratio m√≠nimo (altura/largura) | `0.25` (mais permissivo) | `0.4` (filtra largos) |
| `rtdetr_max_aspect_ratio` | float | Aspect ratio m√°ximo | `6.0` (mais permissivo) | `3.5` (filtra cones) |
| `rtdetr_min_height_px` | int | Altura m√≠nima em pixels | `20` (mais detec√ß√µes) | `50` (filtra pequenos) |
| `rtdetr_min_width_px` | int | Largura m√≠nima em pixels | `10` (mais detec√ß√µes) | `20` (filtra estreitos) |
| `rtdetr_disable_filters` | boolean | Desabilita todos os filtros | `false` (recomendado) | `false` (recomendado) |

**Recomenda√ß√µes:**
- **Performance**: Valores mais permissivos para detectar mais pessoas
- **Qualidade**: Valores mais restritivos para filtrar falsos positivos (cones, objetos)

**Exemplo para filtrar cones:**
```yaml
rtdetr_max_aspect_ratio: 3.5    # Cones s√£o muito alongados (> 4.0)
rtdetr_min_area: 0.0005         # Filtra objetos muito pequenos
rtdetr_min_height_px: 50        # Filtra objetos muito baixos
```

### Par√¢metros do Detector de EPIs

| Par√¢metro | Tipo | Descri√ß√£o | Valores |
|-----------|------|-----------|---------|
| `ppe_detector` | string | Tipo de detector | `"yolo-world"` ou `"owl-v2"` |

**Recomenda√ß√µes:**
- **YOLO-World**: Mais r√°pido, boa precis√£o para objetos grandes
- **OWL-V2**: Mais preciso para roupas e objetos pequenos, mais lento

### Par√¢metros YOLO-World

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `yw_model` | string | Modelo YOLO-World | `yolov8s-world.pt` (r√°pido) | `yolov8m-world.pt` (preciso) |
| `yw_fp16` | boolean | Usar precis√£o FP16 (CUDA) | `true` (mais r√°pido) | `true` (recomendado) |
| `yw_score_thr` | float | Threshold de confian√ßa | `0.20` (mais detec√ß√µes) | `0.15` (mais sens√≠vel) |
| `yw_use_crop` | boolean | Processar crops individuais | `false` (mais r√°pido) | `true` (mais preciso) |
| `yw_crop_padding` | float | Padding relativo ao crop | `0.10` (menos contexto) | `0.20` (mais contexto) |
| `yw_min_crop_size` | int | Tamanho m√≠nimo do crop (px) | `64` (menos processamento) | `32` (detecta pequenos) |
| `yw_imgsz` | int | Tamanho de processamento | `640` (r√°pido) | `1280` (preciso) |

**Modelos dispon√≠veis:**
- `yolov8s-world.pt`: Small (mais r√°pido)
- `yolov8m-world.pt`: Medium (balanceado) ‚≠ê **Recomendado**
- `yolov8l-world.pt`: Large (mais preciso, mais lento)

**Recomenda√ß√µes:**
- **Performance**: `yolov8s-world.pt` + `imgsz: 640` + `use_crop: false`
- **Qualidade**: `yolov8m-world.pt` + `imgsz: 1280` + `use_crop: true` + `score_thr: 0.15`

**Nota sobre `yw_use_crop`:**
- `true`: Processa cada pessoa individualmente (melhor para objetos pequenos, mais lento)
- `false`: Processa frame completo (mais r√°pido, menos preciso para objetos pequenos)

### Par√¢metros OWL-V2

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `ovd_model` | string | Modelo OWL-V2 | `google/owlv2-base-patch16` (r√°pido) | `google/owlv2-large-patch16` (preciso) |
| `ovd_fp16` | boolean | Usar precis√£o FP16 | `true` (mais r√°pido) | `true` (recomendado) |
| `ovd_score_thr` | float | Threshold de confian√ßa | `0.30` (menos falsos) | `0.26` (mais sens√≠vel) |
| `ovd_cache_dir` | string | Diret√≥rio de cache | `"./.hf"` (padr√£o) | `"./.hf"` (padr√£o) |
| `ovd_use_fast` | boolean | Usar processador r√°pido | `true` (recomendado) | `true` (recomendado) |
| `ovd_quantization_mode` | string | Modo de quantiza√ß√£o | `"8bit"` (economia mem√≥ria) | `"none"` (melhor qualidade) |

**Recomenda√ß√µes:**
- **Performance**: `base-patch16` + `fp16: true` + `quantization_mode: "8bit"`
- **Qualidade**: `large-patch16` + `fp16: true` + `quantization_mode: "none"`

### Par√¢metros de Dispositivo

| Par√¢metro | Tipo | Descri√ß√£o | Valores |
|-----------|------|-----------|---------|
| `device` | string | Dispositivo de processamento | `"cuda"` (GPU) ou `"cpu"` |

**Recomenda√ß√µes:**
- Use `cuda` se tiver GPU NVIDIA (muito mais r√°pido)
- Use `cpu` apenas se n√£o tiver GPU (muito mais lento)

### Par√¢metros de Zonas (Heur√≠sticas)

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `head_ratio` | float | Propor√ß√£o da cabe√ßa (0-1) | `0.45` (padr√£o) | `0.45` (padr√£o) |
| `chest_min_ratio` | float | In√≠cio da zona do peito (0-1) | `0.25` (mais √°rea) | `0.25` (mais √°rea) |
| `chest_max_ratio` | float | Fim da zona do peito (0-1) | `0.85` (mais √°rea) | `0.85` (mais √°rea) |

**Explica√ß√£o:**
- `head_ratio: 0.45`: Cabe√ßa ocupa 0-45% da altura do bounding box
- `chest_min_ratio: 0.25` a `chest_max_ratio: 0.85`: Peito/torso ocupa 25-85% da altura

**Recomenda√ß√µes:**
- **Detec√ß√£o de capacetes**: Ajuste `head_ratio` se necess√°rio (padr√£o: `0.45`)
- **Detec√ß√£o de coletes/aventais**: Amplie `chest_max_ratio` para `0.85` (mais √°rea de busca)

### Par√¢metros de Debounce

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `debounce_seconds` | float | Tempo de debounce para viola√ß√µes | `5.0` (mais responsivo) | `8.0` (menos falsos) |

**Recomenda√ß√µes:**
- **Performance**: `5.0` para resposta mais r√°pida
- **Qualidade**: `8.0` para reduzir falsos positivos

### Par√¢metros de Tracking (ByteTrack)

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `track_thresh` | float | Threshold m√≠nimo para criar track | `0.25` (mais tracks) | `0.25` (padr√£o) |
| `match_thresh` | float | Threshold IoU para associar detec√ß√µes | `0.5` (mais re-ID) | `0.3` (menos re-ID) |
| `track_buffer` | int | Frames para manter track perdido | `30` (menos mem√≥ria) | `60` (mais persist√™ncia) |
| `track_iou_thresh` | float | IoU para fallback tracker | `0.5` (mais re-ID) | `0.3` (menos re-ID) |
| `track_max_age` | int | Frames m√°ximos sem detec√ß√£o | `15` (menos mem√≥ria) | `30` (mais persist√™ncia) |

**Recomenda√ß√µes:**
- **Performance**: Valores menores para menos uso de mem√≥ria
- **Qualidade**: Valores maiores para melhor persist√™ncia de IDs (menos re-identifica√ß√£o)

**Explica√ß√£o:**
- `match_thresh` menor = mais permissivo = menos re-ID (recomendado: `0.3`)
- `track_buffer` maior = mant√©m track por mais tempo = mais persist√™ncia (recomendado: `60`)

### Par√¢metros de Sistema de Alertas

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `enable_alerts` | boolean | Habilita envio de alertas | `false` (sem overhead) | `true` (funcional) |
| `show_alert_grid` | boolean | Exibe grid visual | `false` (sem overhead) | `true` (visualiza√ß√£o) |
| `alert_debounce_seconds` | float | Tempo m√≠nimo para confirmar viola√ß√£o | `10.0` (mais r√°pido) | `15.0` (menos falsos) |
| `alert_min_consecutive_frames` | int | Frames consecutivos m√≠nimos | `10` (mais r√°pido) | `20` (menos falsos) |
| `alert_suppression_reset_seconds` | float | Tempo para resetar supress√£o | `15.0` (mais alertas) | `20.0` (menos spam) |
| `alert_hash_ttl_seconds` | float | TTL do hash de viola√ß√£o | `30.0` (menos mem√≥ria) | `60.0` (menos duplicatas) |
| `alert_grid_size` | int | Tamanho do grid (NxN) | `4` (menos c√©lulas) | `8` (mais granular) |
| `timezone_offset_hours` | float | Offset do timezone | `-3.0` (GMT-3) | Ajustar conforme localiza√ß√£o |
| `save_alert_images` | boolean | Salvar imagens de alertas | `false` (sem I/O) | `true` (evid√™ncias) |
| `save_crop_only` | boolean | Salvar apenas crop (n√£o frame completo) | `true` (menos espa√ßo) | `true` (recomendado) |
| `crops_dir` | string | Diret√≥rio para salvar imagens | `"crops"` (padr√£o) | `"crops"` (padr√£o) |

**Recomenda√ß√µes:**
- **Performance**: Desabilite `save_alert_images` se n√£o precisar
- **Qualidade**: Use `alert_min_consecutive_frames: 20` + `alert_debounce_seconds: 15.0` para reduzir falsos positivos

**L√≥gica de Confirma√ß√£o:**
- Alerta √© gerado quando: `frames >= alert_min_consecutive_frames` **E** `tempo >= alert_debounce_seconds`
- Ambos os crit√©rios devem ser satisfeitos (l√≥gica E)

### Par√¢metros de M√©tricas

| Par√¢metro | Tipo | Descri√ß√£o | Performance | Qualidade |
|-----------|------|-----------|-------------|-----------|
| `metrics_overlay` | boolean | Mostrar m√©tricas no v√≠deo | `false` (sem overhead) | `true` (monitoramento) |
| `metrics_csv` | boolean | Salvar m√©tricas em CSV | `false` (sem I/O) | `true` (an√°lise) |
| `metrics_print_every` | int | Imprimir m√©tricas a cada N frames | `60` (menos logs) | `30` (mais frequente) |

**Recomenda√ß√µes:**
- **Performance**: Desabilite m√©tricas se n√£o precisar
- **Qualidade**: Mantenha habilitado para monitoramento

### Par√¢metros de ROI e EPIs

| Par√¢metro | Tipo | Descri√ß√£o | Exemplo |
|-----------|------|-----------|---------|
| `roi_ppe_config` | dict | Mapeia ROI para EPIs obrigat√≥rios | Ver exemplo abaixo |

**Exemplo:**
```yaml
roi_ppe_config:
  roi_epi_on:  # Nome do ROI no JSON
    - helmet        # Aceita qualquer capacete
    - helmet_white  # Exige capacete branco
    - vest          # Exige colete refletivo
    - gloves        # Exige luvas
```

**EPIs dispon√≠veis:**
- `helmet`: Capacete (qualquer cor)
- `helmet_white`, `helmet_red`, `helmet_blue`, `helmet_yellow`, `helmet_brown`, `helmet_gray`: Capacete de cor espec√≠fica
- `vest`: Colete refletivo
- `apron`: Avental
- `gloves`: Luvas
- `ear_protection`: Protetor auricular

### Configura√ß√µes Recomendadas por Cen√°rio

#### üöÄ M√°xima Performance (GPU potente, menos precis√£o)
```yaml
rtdetr_weights: "rtdetr-m.pt"
rtdetr_imgsz: 640
ppe_detector: "yolo-world"
yw_model: "yolov8s-world.pt"
yw_imgsz: 640
yw_use_crop: false
target_fps: 0.5
save_video: false
save_alert_images: false
```

#### ‚öñÔ∏è Balanceado (Recomendado)
```yaml
rtdetr_weights: "rtdetr-l.pt"
rtdetr_imgsz: 1280
ppe_detector: "yolo-world"
yw_model: "yolov8m-world.pt"
yw_imgsz: 1280
yw_use_crop: true
yw_score_thr: 0.15
target_fps: 1.0
alert_min_consecutive_frames: 20
alert_debounce_seconds: 15.0
```

#### üéØ M√°xima Qualidade (GPU potente, m√°xima precis√£o)
```yaml
rtdetr_weights: "rtdetr-l.pt"
rtdetr_imgsz: 1280
ppe_detector: "owl-v2"
ovd_model: "google/owlv2-large-patch16"
yw_imgsz: 1280
yw_use_crop: true
yw_score_thr: 0.15
target_fps: 1.0
alert_min_consecutive_frames: 20
alert_debounce_seconds: 15.0
rtdetr_conf: 0.5
rtdetr_max_aspect_ratio: 3.5
```

## üîê Seguran√ßa

‚ö†Ô∏è **IMPORTANTE**: 
- O arquivo `db_config.env` cont√©m credenciais sens√≠veis
- **N√ÉO** commitado no Git.... criar localmemnte

## üìù Licen√ßa

[Especificar licen√ßa do projeto]

## üë• Contribuidores

[Lista de contribuidores]

## üìû Suporte

Para suporte, entre em contato: contato@platformbuilders.io

---

**Desenvolvido por Platform Builders** - https://paltformbuilders.io
